<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CompleteSolution - Premium POS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* FONTS: INTER (UI) & ORBITRON (CREDITS) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@700;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- INTRO ANIMATION --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            animation: curtainUp 0.8s ease-in-out 3.5s forwards;
        }

        .intro-logo-box {
            opacity: 0; transform: scale(0.5);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards;
        }

        .intro-text-group {
            opacity: 0; transform: translateY(20px);
            animation: slideUpFade 0.8s ease-out 0.6s forwards;
            text-align: center;
        }

        .intro-subtitle {
            opacity: 0; letter-spacing: 0px;
            animation: trackExpand 1s ease-out 0.9s forwards;
        }

        .gelo-char {
            display: inline-block; opacity: 0; transform: translateY(-40px); color: #1e3a8a;
        }
        
        @keyframes dropBounce {
            0% { opacity: 0; transform: translateY(-60px); }
            60% { opacity: 1; transform: translateY(10px); }
            80% { transform: translateY(-5px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .gelo-char:nth-child(1) { animation: dropBounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.6s forwards; }
        .gelo-char:nth-child(2) { animation: dropBounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.7s forwards; }
        .gelo-char:nth-child(3) { animation: dropBounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.8s forwards; }
        .gelo-char:nth-child(4) { animation: dropBounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1.9s forwards; }

        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
        @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }
        @keyframes trackExpand { to { opacity: 1; letter-spacing: 3px; } }
        @keyframes curtainUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100%); opacity: 0; visibility: hidden; } }

        /* UI UTILITIES */
        .card-clean {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
        }

        /* --- NEW INPUT STYLING (For Main Form) --- */
        .inp-clean {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.95rem;
            color: #334155;
            transition: all 0.2s;
            outline: none;
        }
        .inp-clean:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            transform: translateY(-1px);
        }
        .inp-clean::placeholder { color: #94a3b8; font-weight: 500; }
        .inp-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }

        .label-clean {
            display: block;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        /* --- TABLE INPUT STYLING (Visible Borders) --- */
        .tbl-box {
            width: 100%;
            background: #ffffff;
            border: 1px solid #cbd5e1; /* Visible gray border */
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #334155;
            outline: none;
            transition: all 0.2s;
            min-height: 38px;
        }
        .tbl-box:focus {
            border-color: #2563eb;
            background: #eff6ff;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .tbl-box::placeholder {
            color: #cbd5e1;
            font-weight: 400;
        }
        
        /* Dropdown specific for table */
        .tbl-sel {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 0 4px;
            height: 38px;
            font-size: 0.8rem;
            font-weight: 700;
            color: #475569;
            outline: none;
        }

        /* Custom Scrollbars */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="pb-40">

    <div id="intro-overlay">
        <div class="intro-logo-box bg-white p-5 rounded-3xl shadow-xl mb-6 flex items-center justify-center w-24 h-24 md:w-32 md:h-32">
            <i class="fas fa-prescription text-5xl md:text-6xl text-blue-600"></i>
        </div>
        <div class="intro-text-group px-4">
            <div class="font-black text-2xl md:text-4xl tracking-tight mb-2 leading-tight">
                <span class="text-blue-900">COMPLETESOLUTION</span>&nbsp;<span class="text-red-600">PHARMACY</span>
            </div>
            <div class="intro-subtitle text-[10px] md:text-sm font-bold text-slate-400 uppercase tracking-widest">
                Next-Gen Ordering System
            </div>
        </div>
        <div class="mt-12 text-center">
            <div class="text-[9px] font-bold text-slate-400 tracking-widest mb-2 opacity-0 animate-[popIn_0.5s_ease_1.4s_forwards]">DESIGNED BY</div>
            <div class="text-2xl md:text-4xl font-black tracking-[0.5em] pl-2 font-['Orbitron']">
                <span class="gelo-char">G</span><span class="gelo-char">E</span><span class="gelo-char">L</span><span class="gelo-char">O</span>
            </div>
        </div>
    </div>

    <div class="max-w-3xl mx-auto min-h-screen">
        
        <div class="bg-white p-4 pb-6 shadow-sm sticky top-0 z-40 rounded-b-3xl border-b border-slate-200">
            <div class="flex items-center gap-3 mb-3">
                <div class="bg-gradient-to-br from-blue-900 to-blue-800 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shrink-0">
                    <i class="fas fa-mortar-pestle text-lg"></i>
                </div>
                <div>
                    <h1 class="font-black text-lg leading-none tracking-tight">
                        <span class="text-blue-900">COMPLETESOLUTION</span>&nbsp;<span class="text-red-600">PHARMACY</span>
                    </h1>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Professional Management System</p>
                </div>
            </div>
            
            <div class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 flex items-center gap-2 text-slate-600 w-full shadow-inner">
                <i class="far fa-calendar-alt text-blue-500"></i>
                <span id="date-now" class="text-xs font-bold">--</span>
            </div>
        </div>

        <div class="p-3 md:p-5 space-y-4">

            <div class="grid grid-cols-2 gap-3">
                <button onclick="setMode('cash')" id="btn-cash" class="py-4 rounded-xl font-bold text-sm shadow-sm transition-all flex flex-col items-center justify-center gap-1 border bg-white">
                    <i class="fas fa-wallet text-xl mb-1"></i> <span>WALK-IN</span>
                </button>
                <button onclick="setMode('gl')" id="btn-gl" class="py-4 rounded-xl font-bold text-sm shadow-sm transition-all flex flex-col items-center justify-center gap-1 border bg-white">
                    <i class="fas fa-file-contract text-xl mb-1"></i> <span>GUARANTEE</span>
                </button>
            </div>
            
            <div id="status-bar" class="h-1.5 w-full bg-blue-600 rounded-full transition-colors duration-500 opacity-80"></div>

            <div id="gl-section" class="hidden card-clean p-4 border-l-4 border-l-red-500 bg-red-50/50">
                <div class="flex items-center gap-2 mb-4 text-red-700 font-bold text-sm uppercase tracking-wider">
                    <i class="fas fa-landmark"></i> Government Agency Details
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="label-clean">Agency Name</label>
                        <select id="gl-agency" class="inp-clean font-bold text-red-700 cursor-pointer" onchange="checkBranch()">
                            <option value="">Select Agency...</option>
                            <option>PCSO</option>
                            <option>DSWD NCR</option>
                            <option>DSWD BATASAN</option>
                            <option>OFFICE OF THE PRESIDENT</option>
                            <option>OFFICE OF THE VICE PRESIDENT</option>
                            <option>NATIONAL SHRINE</option>
                        </select>
                    </div>
                    <div id="pcso-branch-div" class="hidden">
                        <label class="label-clean">PCSO Branch</label>
                        <select id="gl-branch" class="inp-clean font-bold text-orange-700">
                            <option>MANILA</option><option>BATANGAS</option><option>OLANGAPO</option>
                            <option>LAGUNA</option><option>RIZAL</option><option>BULACAN</option>
                            <option>CDO</option><option>PAMPANGA</option><option>QUEZON</option>
                            <option>ILOILO</option><option>CEBU</option><option>ISABELA</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-clean">GL Reference No.</label>
                        <input type="text" id="gl-ref" class="inp-clean uppercase font-bold" placeholder="Control #">
                    </div>
                    <div>
                        <label class="label-clean">Approved Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-green-600 font-bold">₱</span>
                            <input type="text" id="gl-amount" class="inp-clean pl-7 font-bold text-green-700" placeholder="0.00" onkeyup="formatCurrencyInput(this)" onblur="calculate()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-clean p-5 md:p-6 space-y-4">
                
                <div>
                    <div class="flex justify-between items-center">
                        <label class="label-clean mb-1" id="lbl-name-static">INVOICE TO:</label>
                        <select id="sel-name-format" class="text-[10px] font-bold text-blue-600 bg-blue-50 border border-blue-100 rounded px-2 py-1 outline-none mb-1 cursor-pointer" onchange="updateNameLabel()">
                            <option value="Customer Name">Customer Name</option>
                            <option value="Patient Name">Patient Name</option>
                            <option value="Doctor's Name & Patient">Doctor's Name & Patient</option>
                            <option value="Doctor's Name">Doctor's Name Only</option>
                            <option value="Company Name">Company Name</option>
                        </select>
                    </div>
                    <input type="text" id="inp-name" class="inp-clean text-lg font-bold" placeholder="Enter Customer Name">
                    <div id="name-error-msg" class="text-xs text-red-500 font-bold mt-1 hidden animate-pulse"></div>
                </div>

                <div>
                    <label class="label-clean">CONTACT NUMBER</label>
                    <input type="tel" id="inp-contact" class="inp-clean font-semibold" placeholder="09xxxxxxxxx">
                </div>

                <div>
                    <label class="label-clean">PAYMENT TERMS</label>
                    <div class="relative">
                        <select id="inp-terms" class="inp-clean cursor-pointer bg-white appearance-none font-semibold">
                            <option>Walk in Payment</option>
                            <option>Online Payment (Gcash/Maya)</option>
                            <option>C.O.D.</option>
                            <option>Terms 30 Days</option>
                            <option>Terms 45 Days</option>
                            <option>Check Payment</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>

                <div>
                    <label class="label-clean">COMPLETE ADDRESS / BRANCH</label>
                    <input type="text" id="inp-address" class="inp-clean font-semibold" placeholder="Delivery Address">
                </div>

                <div>
                    <label class="label-clean">DELIVERY OPTION</label>
                    <div class="relative">
                        <select id="inp-delivery" class="inp-clean cursor-pointer bg-white appearance-none font-semibold">
                            <option>Pick-Up</option>
                            <option>Branch Delivery</option>
                            <option>Lalamove</option>
                            <option>Grab Express</option>
                            <option>Courier (LBC/J&T)</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>
            </div>

            <div class="card-clean overflow-hidden">
                <div class="bg-slate-100/80 border-b border-slate-200 p-4">
                    <h3 class="text-xs font-black uppercase text-slate-600 tracking-wider flex items-center gap-2">
                        <i class="fas fa-list-ul"></i> Order Items
                    </h3>
                </div>
                
                <div class="overflow-x-auto custom-scroll p-1">
                    <table class="w-full text-sm min-w-[800px] border-separate border-spacing-y-2 px-2"> 
                        <thead class="text-slate-400 font-bold uppercase text-[10px] tracking-wider">
                            <tr>
                                <th class="pb-2 text-left w-[20%] pl-1">Generic Name</th>
                                <th class="pb-2 text-left w-[20%]">Brand Name</th>
                                <th class="pb-2 text-center w-[10%]">Prep</th>
                                <th class="pb-2 text-center w-[10%]">Expiry</th>
                                <th class="pb-2 text-center w-[8%]">Qty</th>
                                <th class="pb-2 text-right w-[10%]">Price</th>
                                <th class="pb-2 text-center w-[12%]">Discount</th>
                                <th class="pb-2 text-right w-[15%] pr-1">Total</th>
                                <th class="pb-2 text-center w-[5%]"></th>
                            </tr>
                        </thead>
                        <tbody id="tbl-body"></tbody>
                    </table>
                </div>
                
                <div class="p-4 bg-slate-50 border-t border-slate-100">
                    <button onclick="addRow()" class="w-full py-3 bg-white border border-blue-300 text-blue-600 rounded-xl font-bold text-xs hover:bg-blue-50 transition flex items-center justify-center gap-2 shadow-sm active:scale-[0.98]">
                        <i class="fas fa-plus-circle text-lg"></i> ADD MEDICINE ROW
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <div class="bg-[#fff7ed] border border-[#ffedd5] rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[#fed7aa]">
                        <span class="font-bold text-[#9a3412] text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-box-open"></i> Styro / Box
                        </span>
                        <button onclick="addPack('box')" class="bg-white border border-[#fed7aa] text-[#ea580c] px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-sm hover:bg-[#fff7ed] active:scale-95 transition">
                            + Add Box
                        </button>
                    </div>
                    <div id="list-box" class="space-y-2"></div>
                </div>

                <div class="bg-[#f0f9ff] border border-[#e0f2fe] rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-[#bae6fd]">
                        <span class="font-bold text-[#075985] text-xs uppercase tracking-wider flex items-center gap-2">
                            <i class="fas fa-snowflake"></i> Gel / Ice Packs
                        </span>
                        <button onclick="addPack('gel')" class="bg-white border border-[#bae6fd] text-[#0284c7] px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-sm hover:bg-[#f0f9ff] active:scale-95 transition">
                            + Add Ice
                        </button>
                    </div>
                    <div id="list-gel" class="space-y-2"></div>
                </div>
            </div>

            <div class="card-clean p-5 md:p-6 mt-6 bg-white">
                <div class="space-y-2 mb-6 text-sm border-b border-dashed border-slate-200 pb-4">
                    <div class="flex justify-between text-slate-500">
                        <span id="lbl-meds-title">Medicines Subtotal:</span> 
                        <span id="lbl-sub-med" class="font-mono font-bold text-slate-700 text-base">₱ 0.00</span>
                    </div>
                    <div class="flex justify-between text-slate-500">
                        <span id="lbl-pack-title">Packaging (Separate):</span> 
                        <span id="lbl-sub-pack" class="font-mono font-bold text-slate-700 text-base">₱ 0.00</span>
                    </div>
                    
                    <div id="gl-specific-lines" class="hidden pt-2 mt-2 space-y-2">
                        <div class="flex justify-between text-green-600 font-bold">
                            <span>Approved GL Amount:</span> <span id="gl-limit-display">₱ 0.00</span>
                        </div>
                        <div class="flex justify-between text-red-600 font-bold border-t border-dotted pt-1">
                            <span>GL Excess (Payable):</span> <span id="gl-excess-display">₱ 0.00</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-2xl p-5 text-center md:text-right mb-6 shadow-lg relative overflow-hidden">
                    <div class="relative z-10 text-white">
                         <div id="comp-cash">
                            <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Grand Total Amount</span>
                            <span class="block text-5xl font-black tracking-tight leading-none" id="cash-grand">₱ 0.00</span>
                        </div>
                        <div id="comp-gl" class="hidden">
                             <div id="gl-balance-box" class="p-2 rounded-lg text-center transition-all bg-white/10 backdrop-blur-md border border-white/20">
                                <span class="block text-[10px] font-bold uppercase opacity-80" id="gl-status-lbl">Total Cash Out</span>
                                <span class="block text-3xl font-black mt-1 tracking-tight" id="gl-final">₱ 0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-600 rounded-full blur-3xl opacity-20"></div>
                </div>

                <div class="flex items-center gap-3 justify-end mb-6">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest whitespace-nowrap">Processed By:</span>
                    <input type="text" id="inp-proc" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 w-48 text-right font-bold text-blue-900 uppercase text-sm outline-none focus:border-blue-400 transition" placeholder="ENTER NAME">
                </div>

                <button onclick="review()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all active:scale-[0.98] flex items-center justify-center gap-3 text-lg">
                    <i class="fas fa-file-invoice"></i> REVIEW & GENERATE RECEIPT
                </button>
            </div>

        </div>
    </div>

    <div id="modal-review" class="fixed inset-0 z-50 hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[90vh] flex flex-col overflow-hidden animate-[slideUp_0.3s_ease-out]">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-white/10 p-2 rounded-lg"><i class="fas fa-receipt"></i></div>
                    <div><h2 class="font-bold text-base">Summary</h2><p class="text-[10px] text-slate-400">Verify details</p></div>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/20 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-0 overflow-y-auto custom-scroll flex-1 bg-slate-50" id="review-content-area"></div>
            
            <div class="p-4 border-t bg-white flex gap-3 shrink-0">
                <button onclick="closeModal()" class="px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 transition border w-1/3">Edit</button>
                <button onclick="copyToClipboard()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg transition flex items-center justify-center gap-2 active:bg-blue-800">
                    <i class="fas fa-copy"></i> COPY DETAILS
                </button>
            </div>
        </div>
    </div>

    <textarea id="hidden-copy-text" class="hidden"></textarea>

    <script>
        let MODE = 'cash';
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('date-now').innerText = new Date().toLocaleString('en-US', {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'numeric'});
            setMode('cash');
        });

        function setMode(m) {
            clearForm();
            MODE = m;
            const isGL = m === 'gl';
            const bCash = document.getElementById('btn-cash');
            const bGl = document.getElementById('btn-gl');
            const bar = document.getElementById('status-bar');

            if(isGL) {
                bCash.className = "py-4 rounded-xl font-bold text-sm text-slate-400 border border-slate-200 flex flex-col items-center justify-center gap-1 bg-white opacity-60";
                bGl.className = "py-4 rounded-xl font-bold text-sm text-red-600 border-2 border-red-600 bg-red-50 shadow-md flex flex-col items-center justify-center gap-1";
                bar.className = "h-1.5 w-full bg-red-600 rounded-full";
                document.getElementById('sel-name-format').value = "Patient Name";
                document.getElementById('sel-name-format').disabled = true;
                updateNameLabel();
            } else {
                bCash.className = "py-4 rounded-xl font-bold text-sm text-blue-700 border-2 border-blue-600 bg-blue-50 shadow-md flex flex-col items-center justify-center gap-1";
                bGl.className = "py-4 rounded-xl font-bold text-sm text-slate-400 border border-slate-200 flex flex-col items-center justify-center gap-1 bg-white opacity-60";
                bar.className = "h-1.5 w-full bg-blue-600 rounded-full";
                document.getElementById('sel-name-format').disabled = false;
                document.getElementById('sel-name-format').value = "Customer Name";
                updateNameLabel();
            }

            toggle('gl-section', isGL);
            toggle('gl-specific-lines', isGL);
            toggle('comp-gl', isGL);
            toggle('comp-cash', !isGL);
            if(document.querySelectorAll('#tbl-body tr').length === 0) addRow();
        }

        function updateNameLabel() {
            const format = document.getElementById('sel-name-format').value;
            const inp = document.getElementById('inp-name');
            const err = document.getElementById('name-error-msg');
            inp.classList.remove('inp-error');
            err.classList.add('hidden');
            if(format === "Customer Name") inp.placeholder = "Enter Customer Name";
            else if(format === "Patient Name") inp.placeholder = "Enter Patient Name";
            else if(format === "Doctor's Name & Patient") inp.placeholder = "Dr. [Name] / Patient [Name]";
            else if(format === "Doctor's Name") inp.placeholder = "Dr. [Name]";
            else if(format === "Company Name") inp.placeholder = "Company / Organization Name";
        }

        function clearForm() {
            document.getElementById('inp-name').value = '';
            document.getElementById('inp-contact').value = '';
            document.getElementById('inp-address').value = '';
            document.getElementById('inp-delivery').selectedIndex = 0;
            document.getElementById('inp-terms').selectedIndex = 0;
            document.getElementById('gl-agency').selectedIndex = 0;
            document.getElementById('gl-branch').selectedIndex = 0;
            document.getElementById('pcso-branch-div').style.display = 'none';
            document.getElementById('gl-ref').value = '';
            document.getElementById('gl-amount').value = '';
            document.getElementById('tbl-body').innerHTML = '';
            document.getElementById('list-box').innerHTML = '';
            document.getElementById('list-gel').innerHTML = '';
            document.getElementById('inp-name').classList.remove('inp-error');
            document.getElementById('name-error-msg').classList.add('hidden');
            calculate();
        }

        function toggle(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function checkBranch() {
            const ag = document.getElementById('gl-agency').value;
            document.getElementById('pcso-branch-div').style.display = ag === 'PCSO' ? 'block' : 'none';
        }

        function formatCurrencyInput(input) {
            let value = input.value.replace(/,/g, '').replace(/[^\d.]/g, '');
            if ((value.match(/\./g) || []).length > 1) value = value.replace(/\.+$/, "");
            input.value = value ? parseFloat(value).toLocaleString('en-US') : '';
        }

        // --- NEW ADD ROW FUNCTION WITH SWAPPED QTY/PRICE ---
        function addRow() {
            const tr = document.createElement('tr');
            tr.className = "group";
            tr.innerHTML = `
                <td class="p-1"><input class="tbl-box" placeholder="Generic Name"></td>
                <td class="p-1"><input class="tbl-box font-black" placeholder="Brand Name"></td>
                <td class="p-1"><input class="tbl-box text-center" placeholder="Box/Bot"></td>
                <td class="p-1 text-center"><select class="tbl-sel cursor-pointer w-full"><option>Long</option><option class="text-red-600">Near</option></select></td>
                <td class="p-1"><input type="number" class="tbl-box text-center qty" placeholder="1" value="1" oninput="calculate()"></td>
                <td class="p-1"><input type="number" class="tbl-box text-right price font-mono" placeholder="0.00" oninput="calculate()"></td>
                <td class="p-1">
                     <div class="flex items-center border border-slate-300 rounded-md bg-white overflow-hidden h-[38px] w-full shadow-sm">
                        <select class="h-full bg-slate-100 text-[10px] font-bold px-1 border-r outline-none dtype cursor-pointer text-center w-10 text-slate-600" onchange="calculate()">
                            <option value="n">-</option><option value="%">%</option><option value="-">₱</option>
                        </select>
                        <input type="number" class="w-full px-1 text-center text-xs outline-none dval h-full text-red-500 font-bold" disabled placeholder="0" oninput="calculate()">
                    </div>
                </td>
                <td class="p-1 text-right font-black text-slate-700 total font-mono">0.00</td>
                <td class="p-1 text-center"><button onclick="this.closest('tr').remove();calculate()" class="text-slate-300 hover:text-red-500 transition w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button></td>
            `;
            document.getElementById('tbl-body').appendChild(tr);
        }

        function addPack(type) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-2 text-xs border-b border-gray-100 pb-2 mb-2 last:border-0";
            const opts = type === 'box' 
                ? `<option value="55">Styro Small (55)</option><option value="150">Styro Med (150)</option><option value="180">Styro Lrg (180)</option><option value="125">C2 Box (125)</option><option value="150">Size C (150)</option>`
                : `<option value="35">Gel Pack (35)</option><option value="50">Ice Pack L (50)</option>`;
            
            div.innerHTML = `
                <select class="flex-1 p-2 border rounded bg-white psel font-bold text-slate-700 outline-none cursor-pointer h-10" onchange="calculate()">${opts}</select>
                <div class="flex items-center"><span class="text-slate-400 mr-1 hidden md:inline">x</span><input type="number" class="w-12 text-center border rounded p-1 pqty font-bold h-10" value="1" oninput="calculate()"></div>
                <span class="font-bold w-16 text-right ptot text-slate-800 font-mono">0.00</span>
                <button onclick="this.parentElement.remove();calculate()" class="text-red-300 ml-1 md:ml-2 hover:text-red-600 w-8 h-10"><i class="fas fa-times"></i></button>
            `;
            document.getElementById(type === 'box' ? 'list-box' : 'list-gel').appendChild(div);
            calculate();
        }

        function fmt(n) { return '₱ ' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}); }

        function calculate() {
            let medSum = 0;
            document.querySelectorAll('#tbl-body tr').forEach(tr => {
                const p = parseFloat(tr.querySelector('.price').value) || 0;
                const q = parseFloat(tr.querySelector('.qty').value) || 0;
                let sub = p * q;
                const dt = tr.querySelector('.dtype');
                const dv = tr.querySelector('.dval');
                dv.disabled = dt.value === 'n';
                if(dt.value === 'n') dv.value = '';
                else {
                    const val = parseFloat(dv.value) || 0;
                    if(dt.value === '%') sub -= sub * (val/100);
                    else sub -= val;
                }
                tr.querySelector('.total').innerText = sub.toLocaleString('en-US', {minimumFractionDigits:2});
                medSum += sub;
            });

            let packSum = 0;
            document.querySelectorAll('#list-box > div, #list-gel > div').forEach(d => {
                const v = parseFloat(d.querySelector('.psel').value)||0;
                const q = parseFloat(d.querySelector('.pqty').value)||0;
                const t = v*q;
                d.querySelector('.ptot').innerText = t.toFixed(2);
                packSum += t;
            });

            document.getElementById('lbl-sub-med').innerText = fmt(medSum);
            document.getElementById('lbl-sub-pack').innerText = fmt(packSum);

            const grandTotal = medSum + packSum;

            if(MODE === 'cash') {
                document.getElementById('cash-grand').innerText = fmt(grandTotal);
            } else {
                let glRaw = document.getElementById('gl-amount').value.replace(/,/g, '');
                const glLimit = parseFloat(glRaw) || 0;
                let excessMeds = 0;
                if(medSum > glLimit) { excessMeds = medSum - glLimit; }
                const totalCashOut = excessMeds + packSum;

                document.getElementById('gl-limit-display').innerText = fmt(glLimit);
                document.getElementById('gl-excess-display').innerText = fmt(excessMeds);
                document.getElementById('gl-final').innerText = fmt(totalCashOut);
                
                const sl = document.getElementById('gl-status-lbl');
                const box = document.getElementById('gl-balance-box');

                if(totalCashOut > 0.01) {
                    sl.innerText = "TOTAL CASH OUT REQUIRED"; 
                    box.className = "p-2 rounded-lg text-center transition-all bg-red-100 border border-red-300 text-red-700";
                } else {
                    sl.innerText = "NO CASH OUT (FULLY COVERED)"; 
                    box.className = "p-2 rounded-lg text-center transition-all bg-green-100 border border-green-300 text-green-700";
                }
            }
        }

        function validateInput() {
            if(MODE === 'gl') return true;
            const format = document.getElementById('sel-name-format').value;
            const nameVal = document.getElementById('inp-name').value.trim();
            const errDiv = document.getElementById('name-error-msg');
            const inp = document.getElementById('inp-name');
            inp.classList.remove('inp-error');
            errDiv.classList.add('hidden');
            
            if(!nameVal) {
                inp.classList.add('inp-error');
                errDiv.innerText = "⚠️ Name cannot be empty.";
                errDiv.classList.remove('hidden');
                return false;
            }
            if (format === "Doctor's Name" || format === "Doctor's Name & Patient") {
                if (!/^Dr\.|^Dra\./i.test(nameVal)) {
                    inp.classList.add('inp-error');
                    errDiv.innerText = "⚠️ STRICT: Must start with 'Dr.' or 'Dra.'";
                    errDiv.classList.remove('hidden');
                    return false;
                }
            }
            if (format === "Doctor's Name & Patient") {
                if (!nameVal.includes("/")) {
                    inp.classList.add('inp-error');
                    errDiv.innerText = "⚠️ STRICT: Must separate Doctor and Patient with '/'";
                    errDiv.classList.remove('hidden');
                    return false;
                }
            }
            if (nameVal.length < 3) {
                 inp.classList.add('inp-error');
                 errDiv.innerText = "⚠️ Name too short.";
                 errDiv.classList.remove('hidden');
                 return false;
            }
            return true;
        }

        function review() {
            if(!validateInput()) { alert("Please correct the input errors."); return; }
            const proc = document.getElementById('inp-proc').value;
            if(!proc.trim()) { alert("Please enter 'Processed By' name."); return; }

            // BUILD MODAL HTML
            let h = `<div class="p-6 font-mono text-sm text-slate-700">`;
            h += `<div class="text-center mb-6 pb-4 border-b border-dashed border-slate-300">`;
            h += `<div class="flex justify-center gap-2 items-center text-xl font-black font-sans tracking-tight"><span class="text-blue-900">COMPLETESOLUTION</span><span class="text-red-600">PHARMACY</span></div>`;
            h += `<p class="text-[10px] text-slate-400 uppercase tracking-widest font-sans mt-1">Transaction Receipt</p></div>`;
            h += `<div class="flex justify-between mb-2 text-xs md:text-sm"><span class="font-bold">Date:</span> <span>${new Date().toLocaleString()}</span></div>`;
            h += `<div class="flex justify-between mb-4 text-xs md:text-sm"><span class="font-bold">Type:</span> <span class="uppercase font-bold ${MODE==='gl'?'text-red-600':'text-blue-600'}">${MODE==='gl'?'Guarantee Letter':'Walk-in / Cash'}</span></div>`;
            h += `<div class="bg-slate-50 p-3 rounded mb-4 border border-slate-100">`;
            const labelName = document.getElementById('sel-name-format').value;
            h += `<div class="flex justify-between mb-1"><span class="text-xs text-slate-400 uppercase font-bold">Bill To (${labelName}):</span></div>`;
            h += `<div class="font-bold text-lg mb-2 border-b border-slate-200 pb-2 break-words">${document.getElementById('inp-name').value || 'N/A'}</div>`;
            h += `<div class="grid grid-cols-2 gap-2 text-xs">`;
            h += `<div><span class="block text-slate-400">Payment</span><b>${document.getElementById('inp-terms').value}</b></div>`;
            h += `<div><span class="block text-slate-400">Delivery</span><b>${document.getElementById('inp-delivery').value}</b></div>`;
            h += `<div class="col-span-2"><span class="block text-slate-400">Address</span><b>${document.getElementById('inp-address').value || 'N/A'}</b></div></div>`;
            
            if(MODE === 'gl') {
                h += `<div class="mt-2 pt-2 border-t border-slate-200"><div class="font-bold text-red-600 text-xs uppercase">GL Agency Info:</div>`;
                const agency = document.getElementById('gl-agency').value;
                let agencyDisplay = agency;
                if(agency === 'PCSO') { agencyDisplay += ` (${document.getElementById('gl-branch').value})`; }
                h += `<div>${agencyDisplay}</div><div>Ref: ${document.getElementById('gl-ref').value}</div></div>`;
            }
            h += `</div>`;

            // CLIPBOARD TEXT CONSTRUCTION
            let txt = `================================\n`;
            txt += `   COMPLETESOLUTION PHARMACY    \n`;
            txt += `================================\n`;
            txt += `DATE: ${new Date().toLocaleString()}\n`;
            txt += `TYPE: ${MODE === 'gl' ? 'GUARANTEE LETTER' : 'WALK-IN / CASH'}\n`;
            txt += `--------------------------------\n`;
            txt += `CUSTOMER DETAILS:\n`;
            txt += `NAME: ${document.getElementById('inp-name').value}\n`;
            txt += `CONTACT: ${document.getElementById('inp-contact').value || 'N/A'}\n`;
            txt += `PAYMENT: ${document.getElementById('inp-terms').value}\n`;
            txt += `DELIVERY: ${document.getElementById('inp-delivery').value}\n`;
            txt += `ADDRESS: ${document.getElementById('inp-address').value || 'N/A'}\n`;
            
            if(MODE === 'gl') {
                 const ag = document.getElementById('gl-agency').value;
                 const br = document.getElementById('gl-branch').value;
                 txt += `AGENCY: ${ag} ${ag==='PCSO' ? '('+br+')' : ''}\n`;
                 txt += `REF #: ${document.getElementById('gl-ref').value}\n`;
            }
            txt += `--------------------------------\n`;

            h += `<table class="w-full mb-4 text-xs md:text-sm"><thead><tr class="border-b border-black"><th class="text-left pb-1">Item</th><th class="text-center pb-1">Qty</th><th class="text-right pb-1">Amount</th></tr></thead><tbody>`;
            
            txt += `ITEMS:\n`;
            document.querySelectorAll('#tbl-body tr').forEach(tr => {
                const i = tr.querySelectorAll('input');
                // Indices changed: 0:Gen, 1:Brand, 2:Box, 3:QTY, 4:PRICE
                const gen = i[0].value; 
                const br = i[1].value; 
                const qt = i[3].value; // New Index for QTY
                const tot = tr.querySelector('.total').innerText;
                if(gen || br) {
                    h += `<tr><td class="py-1"><div class="font-bold">${br}</div><div class="text-[10px] text-slate-500">${gen}</div></td><td class="text-center align-top py-1">${qt}</td><td class="text-right align-top py-1">${tot}</td></tr>`;
                    txt += ` - ${br} (${gen}) [Qty: ${qt}] = ${tot}\n`;
                }
            });

            const boxCount = document.getElementById('list-box').children.length;
            const gelCount = document.getElementById('list-gel').children.length;
            
            if(boxCount > 0 || gelCount > 0) {
                 h += `<tr class="border-t border-dotted"><td colspan="3" class="pt-2 text-[10px] font-bold uppercase text-slate-400">Packaging (Separate Transaction)</td></tr>`;
                 txt += `--------------------------------\n`;
                 txt += `PACKAGING (SEPARATE TRANS):\n`;
                 document.querySelectorAll('#list-box > div, #list-gel > div').forEach(d => {
                    const s = d.querySelector('select');
                    const label = s.options[s.selectedIndex].text;
                    const qty = d.querySelector('.pqty').value;
                    const tot = d.querySelector('.ptot').innerText;
                    h += `<tr><td class="py-1 text-xs pl-2">${label}</td><td class="text-center py-1 text-xs">${qty}</td><td class="text-right py-1 text-xs">${tot}</td></tr>`;
                    txt += ` - ${label} [Qty: ${qty}] = ${tot}\n`;
                 });
            }
            h += `</tbody></table>`;

            h += `<div class="border-t border-black pt-2">`;
            txt += `================================\n`;
            txt += `FINANCIAL BREAKDOWN:\n`;

            if(MODE === 'gl') {
                 const glRaw = document.getElementById('gl-amount').value.replace(/,/g, '');
                 const glLimit = parseFloat(glRaw) || 0;
                 const packFee = document.getElementById('lbl-sub-pack').innerText;
                 const medsTotal = parseFloat(document.getElementById('lbl-sub-med').innerText.replace(/[^\d.]/g, ''));
                 let excess = medsTotal > glLimit ? medsTotal - glLimit : 0;
                 const totalCash = parseFloat(document.getElementById('gl-final').innerText.replace(/[^\d.]/g, ''));

                 h += `<div class="flex justify-between text-sm"><span>Meds Total</span><span>${document.getElementById('lbl-sub-med').innerText}</span></div>`;
                 h += `<div class="flex justify-between text-sm text-green-600 mb-2"><span>GL Coverage</span><span>-${fmt(glLimit)}</span></div>`;
                 
                 txt += `MEDS TOTAL: ${document.getElementById('lbl-sub-med').innerText}\n`;
                 txt += `APPROVED GL AMOUNT: ${fmt(glLimit)}\n`;

                 if(excess > 0) {
                     h += `<div class="flex justify-between text-sm text-red-600 font-bold border-t border-dotted"><span>Excess Meds (Payable)</span><span>${fmt(excess)}</span></div>`;
                     txt += `EXCESS MEDS (PAYABLE): ${fmt(excess)}\n`;
                 } else {
                     h += `<div class="text-xs text-green-600 text-right italic border-t border-dotted">Meds Fully Covered</div>`;
                     txt += `MEDS STATUS: FULLY COVERED\n`;
                 }

                 if(boxCount > 0 || gelCount > 0) {
                    h += `<div class="flex justify-between text-sm font-bold mt-1"><span>Packaging Fee</span><span>${packFee}</span></div>`;
                    txt += `PACKAGING FEE: ${packFee}\n`;
                 }

                 h += `<div class="flex justify-between font-black text-xl mt-2 pt-2 border-t border-black"><span>TOTAL CASH OUT</span><span>${document.getElementById('gl-final').innerText}</span></div>`;
                 txt += `--------------------------------\n`;
                 txt += `TOTAL CASH OUT: ${document.getElementById('gl-final').innerText}\n`;
                 
                 if(totalCash <= 0) txt += `STATUS: NO PAYMENT REQUIRED\n`;
                 else txt += `STATUS: PAYMENT REQUIRED\n`;

            } else {
                 h += `<div class="flex justify-between font-black text-xl"><span>GRAND TOTAL</span><span>${document.getElementById('cash-grand').innerText}</span></div>`;
                 txt += `GRAND TOTAL: ${document.getElementById('cash-grand').innerText}\n`;
            }
            h += `</div><div class="mt-6 text-center text-xs text-slate-400">Processed By: <span class="font-bold text-slate-600 uppercase">${proc}</span></div></div>`;
            
            txt += `================================\n`;
            txt += `Processed By: ${proc}\n`;

            document.getElementById('review-content-area').innerHTML = h;
            document.getElementById('hidden-copy-text').value = txt;
            document.getElementById('modal-review').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-review').classList.add('hidden'); }
        function copyToClipboard() {
            const t = document.getElementById('hidden-copy-text');
            t.select(); t.setSelectionRange(0,99999);
            navigator.clipboard.writeText(t.value).then(() => alert("Receipt Details Copied!"));
        }
    </script>
</body>
</html>
